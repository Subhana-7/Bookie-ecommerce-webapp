<head>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>

    .sidebar {
      background-color: maroon;
      color: white;
      padding: 20px;
      height: 100vh;
    }

    .product-card {
      height: 100%; 
    }

    .search-bar {
      margin-bottom: 20px;
    }

    .search-input {
      width: 100%;
    }

    .card-body {
      display: flex;
      flex-direction: column;
      justify-content: space-between; 
    }
  </style>
</head>

<%- include("../../views/partials/user/header") %>
<div class="container">
  <nav class="breadcrumbs">
    <a href="/">Home</a> &gt; <span>Products</span>
  </nav>

  <div class="content row">
    <aside class="sidebar col-md-3">
      <h2 class="text-white">Filter & Sort</h2>
      <div class="filter-section"><br>
        <h5 class="text-white">Sort By:</h5>
        <select id="sortOptions" class="form-control">
            <option value="default">Default</option>
            <option value="popularity">Popularity</option>
            <option value="priceAsc">Price: Low to High</option>
            <option value="priceDesc">Price: High to Low</option>
            <option value="averageRating">Average Ratings</option>
            <option value="featured">Featured</option>
            <option value="newest">Newest Arrivals</option>
            <option value="aToZ">A - Z</option>
            <option value="zToA">Z - A</option>
        </select>
    </div><br>
    

    <div class="filter-section">
     
      <ul class="list-unstyled">
        <li>
          <input type="checkbox" id="in-stock" onchange="applyFilters()" <%= inStock ? 'checked' : '' %> />
          <label for="in-stock">Show only in-stock Books</label>
        </li>
        <h4 class="text-white">Categories</h4><br>
        <% categories.forEach(category => { %>
          <li>
            <input 
            type="checkbox" 
            id="category-<%= category._id %>" 
            value="<%= category._id %>" 
            onchange="applyFilters()" 
            <% if (categoryFilter && categoryFilter.split(',').includes(category._id)) { %> checked <% } %> 
          />
          <label for="category-<%= category._id %>"><%= category.name %></label>   
          </li>
        <% }) %>
      </ul>
    </div>
       

    
    </aside>

    <main class="product-list col-md-9">
      <h2>Product List</h2>

    <div class="search-bar d-flex">
      <input
        type="text"
        placeholder="Search products..."
        class="form-control search-input"
        value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>"
      />
      <button class="btn btn-primary ml-2 search-btn">Search</button>
    </div>

      

      <div class="row">
        <% products.forEach(product => { %>
          <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <a href="/product-details/<%= product._id %>">
              <div class="product-card card">
                <img src="uploads/product-images/<%= product.productImage[0] %>" class="card-img-top" alt="<%= product.productName %>" />
                <div class="card-body">
                  <h3 class="card-title"><%= product.productName %></h3>
                  <p class="card-text">Category: <%= product.category.name %></p>
                  <p class="card-text">Author: <%= product.author %></p>
                  <p class="card-text">Publisher: <%= product.publisher %></p>
          
                  <p>
                    Stock Status: 
                    <% if (product.quantity <= 0) { %>
                        <span style="color: red;">Out of Stock</span>
                    <% } else { %>
                        <span style="color: green;" ><%=product.quantity%> Stock left</span><br>
                        <span style="color: green;">-In Stock</span>
                    <% } %>
                  </p>
                  <p class="price">
                    <% 
                      let finalPrice = product.salePrice;
                      
                      if (product.category && product.category.categoryOffer > 0) {
                        let discountedPrice = finalPrice - (finalPrice * (product.category.categoryOffer / 100));
                        finalPrice = discountedPrice;
                      }
                  
                      if (product.productOffer > 0) {
                        finalPrice = finalPrice - (finalPrice * (product.productOffer / 100));
                      }
                  
                      let finalDiscountedPrice = finalPrice.toFixed(2);
                    %>
                  
                    <% if (product.category && product.category.categoryOffer > 0) { %>
                      <span style="text-decoration: line-through; color: grey;">₹<%= product.salePrice %></span><br>
                    <% } %>
                  
                    <span style="color: red;">₹<%= finalDiscountedPrice %></span>
                  
                    <% if (product.category && product.category.categoryOffer > 0) { %>
                      <p>Category Discount: <span style="color: red;"><%= product.category.categoryOffer %>%</span></p>
                    <% } %>
                  
                    <% if (product.productOffer > 0) { %>
                      <p>Product Discount: <span style="color: red;"><%= product.productOffer %>%</span></p>
                    <% } %>
                  </p>
                  
          
                </div>
              </div>
            </a>
          </div>
          
          
        <% }) %>
      </div>
    </main>
  </div>
</div>

<script>
document.querySelector('.search-btn').addEventListener('click', function() {
  const searchValue = document.querySelector('.search-input').value.trim();
  
  if (!searchValue) {
    window.location.href = `/products`; 
  } else {
    window.location.href = `/products?search=${encodeURIComponent(searchValue)}`;
  }
});


document.getElementById('sortOptions').addEventListener('change', function() {
    const sortValue = this.value;

    if (sortValue === 'default') {
        window.location.href = '/products';
    } else {
        window.location.href = `/products?sort=${sortValue}`;
    }
});


    

function applyFilters() {
  let filters = new URLSearchParams();

  const inStockChecked = document.getElementById('in-stock').checked;
  filters.set('inStock', inStockChecked ? 'true' : 'false');

  const categoryCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="category-"]'); 
  categoryCheckboxes.forEach((checkbox) => {
    if (checkbox.checked) {
      filters.append('category', checkbox.value); 
    }
  });

  window.location.href = '/products?' + filters.toString();
}


    

</script>